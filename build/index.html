<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>locoThrottle.js Documentation</title>

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

      <script>
        $(function() {
          setupLanguages(["javascript"]);
        });
      </script>
  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='http://evilgeniustech.com'>EvilGeniusTech Blog</a></li>
            <li><a href="http://github.com/k4kfh/LocoThrottleJS" target="_blank">locoThrottle.js on GitHub</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="introduction">Introduction</h1>

<p>Welcome to the locoThrottle.js docs!</p>

<p>This documentation system is built using Slate. We try very hard to keep it up to date, but we can&rsquo;t always update it immediately. Consequently, if you run into a problem despite following the docs, please post an issue on <a href="http://github.com/k4kfh/LocoThrottleJS/">the project&rsquo;s GitHub page</a>.</p>

<h1 id="interfacing-with-jmri">Interfacing with JMRI</h1>

<h2 id="the-jmri-object-introduction">The <code class="prettyprint">jmri</code> Object - Introduction</h2>

<p>The <code class="prettyprint">jmri</code> object is responsible for interfacing the rest of the program to your layout via JMRI. It communicates using JMRI&rsquo;s WebSockets JSON service, described <a href="http://jmri.sourceforge.net/help/en/html/web/JsonServlet.shtml">here</a>.</p>

<h2 id="websockets-basics">WebSockets Basics</h2>

<p>The code for this is spread amongst two files:</p>

<ul>
<li><code class="prettyprint">jmri-core.js</code></li>
<li><code class="prettyprint">websockets.js</code></li>
</ul>

<p>Naturally, most of the code to do with lower level WebSockets stuff (like connecting, sending raw JSON commands, etc) is in the <code class="prettyprint">websockets.js</code> file. In contrast, most of the code dealing with application-level things, such as the JMRI roster, is contained in <code class="prettyprint">jmri-core.js</code>.</p>

<h3 id="connecting-to-jmri">Connecting to JMRI</h3>

<blockquote>
<p>The IP address or hostname must be a string, but the port can be a normal JavaScript number.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">jmriAddress</span> <span class="o">=</span> <span class="s2">"192.168.1.10"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">jmriPort</span> <span class="o">=</span> <span class="mi">12080</span><span class="p">;</span>

<span class="nx">connect</span><span class="p">(</span><span class="nx">jmriAddress</span><span class="p">,</span> <span class="nx">jmriPort</span><span class="p">);</span>
</code></pre>

<p>Connecting to your JMRI PC is very simple. There is a function called <code class="prettyprint">connect()</code> which accepts two arguments:</p>

<ul>
<li><code class="prettyprint">ip</code> - This is the IP address (or hostname; that works too)</li>
<li><code class="prettyprint">port</code> - This is whatever port your JMRI web server is running on. The default is 12080, but you can use whatever you want.</li>
</ul>

<p>This function should not be dealt with by other developers. This should only be dealt with from the &ldquo;Connection&rdquo; page within locoThrottle.js, which provides an easy, simple GUI to connect to your layout with. The only reason this function is documented is for reference.</p>

<h3 id="sending-commands">Sending Commands</h3>

<blockquote>
<p>We have to have this variable as a string or it will break things. You should stringify your object if you have an actual object.
It&rsquo;s also very important to make sure the string contains double quotes. JMRI will return an error complaining that you didn&rsquo;t use double quotes if you try and use &rsquo; instead of &ldquo;, and you&rsquo;ll be unhappy.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">someCommand</span> <span class="o">=</span> <span class="s1">'{"list":"trains"}'</span><span class="p">;</span>

<span class="nx">sendcmd</span><span class="p">(</span><span class="nx">someCommand</span><span class="p">);</span>
</code></pre>

<blockquote>
<p>Since WebSockets is full-duplex, you can&rsquo;t use it like a question-answer style communication system. This function won&rsquo;t return what the server responds with, because the server could respond with anything at any time. There is a function called processReply() that handles this, so if you need to process a reply, you&rsquo;ll probably be out of luck unless you come make an issue on GitHub.</p>
</blockquote>

<p>Sending commands in raw JSON is very simple. It is handled by the <code class="prettyprint">sendcmd()</code> function, which behaves similar to the <code class="prettyprint">ws.send()</code> function, but also adds easy errors and user alerts when the connection has problems.</p>

<p><code class="prettyprint">sendcmd()</code> accepts 1 argument: a JSON object, as a string.</p>

<h2 id="jmri-roster-basics">JMRI Roster Basics</h2>

<p>locoThrottle.js provides a number of ways for interfacing with the JMRI roster. It also automatically kept up-to-date via the WebSockets service, so if you request roster data it will automatically be fed into all the roster variables and objects.</p>

<h2 id="roster-objects">Roster Objects</h2>

<blockquote>
<p>Option 1 - Array of entry objects
An example of this can be seen below.</p>
</blockquote>
<pre class="highlight json"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rosterEntry"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CBQ2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"isLongAddress"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nt">"road"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Chicago, Burlington, and Quincy"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"mfg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bachmann Trains"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"decoderModel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LokSound Select EMD 567"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"decoderFamily"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ESU LokSound Select"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nt">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is the sound equipped CB&amp;Q loco"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"maxSpeedPct"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"shuntingFunction"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nt">"functionKeys"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F0"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Light"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lockable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"selectedIcon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>

<blockquote>
<p>We removed the rest of the function array (above) because it is excessively long, and you&rsquo;d better get the idea anyway.</p>

<p>Option 2 - Object with sub-objects for each roster entry. This is for the same roster entry as the previous example, and as you can see the name of its sub-object is the name of the roster entry, which is the string <code class="prettyprint">&quot;CBQ2&quot;</code>.</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
</span><span class="nt">"CBQ2"</span><span class="p">:{</span><span class="w">
      </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CBQ2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"isLongAddress"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nt">"road"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Chicago, Burlington, and Quincy"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"mfg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bachmann Trains"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"decoderModel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LokSound Select EMD 567"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"decoderFamily"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ESU LokSound Select"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"model"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nt">"comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is the sound equipped CB&amp;Q loco"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"maxSpeedPct"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"image"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">"shuntingFunction"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nt">"functionKeys"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F0"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Light"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lockable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"selectedIcon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F1"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bell"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lockable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"selectedIcon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F2"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Horn"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lockable"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
          </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"selectedIcon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"F3"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Coupler Sound"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"lockable"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nt">"icon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
          </span><span class="nt">"selectedIcon"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
        </span><span class="p">},</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>

<p>There are two ways you can access the roster in locoThrottle.js, both of which are exemplified to the right:</p>

<ol>
<li><p>An array of objects, just as it is provided by JMRI, stored in the array <code class="prettyprint">jmri.roster.raw</code>.</p></li>
<li><p>An object with sub-objects for each roster entry, with the roster entry name as the key. This is stored in the object <code class="prettyprint">jmri.roster.reformat</code>.</p></li>
</ol>

<p>Both of these options are acceptable, and which one is best is highly dependent on your use case. Both options are kept automatically up-to-date by the WebSockets reply processor, so there&rsquo;s really no wrong way to go here.</p>

<h2 id="roster-functions">Roster Functions</h2>

<p>There are several functions built into the <code class="prettyprint">jmri.roster</code> object that make dealing with roster data much easier. Each is listed below, with an explanation, and code samples.</p>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">criteria</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"decoderFamily"</span><span class="p">:</span><span class="s2">"Magic DCC Decoder Family That Doesn't Exist"</span><span class="p">}</span>

<span class="c1">//We must be connected to JMRI before we run this, or there will be no roster data to check it against.</span>
<span class="nx">matchingEntries</span> <span class="o">=</span> <span class="nx">jmri</span><span class="p">.</span><span class="nx">roster</span><span class="p">.</span><span class="nx">matchProperty</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">matchingEntries</span><span class="p">)</span>
<span class="c1">//Would log an array of roster entry names that matched, for example:</span>
<span class="c1">//matchingEntries = ["Magical Locomotive That Doesn't exist", "Another Matching One's name"]</span>
<span class="c1">//So jmri.roster.reformat["Another Matching One's name"]["decoderFamily"] would yield "Magic DCC Decoder Family That Doesn't Exist" in this use case.</span>
</code></pre>

<h3 id="jmri-roster-matchproperty-property"><code class="prettyprint">jmri.roster.matchProperty(property)</code></h3>

<p>This function is used to look up roster entries with a specific property. It was created with the purpose of matching DCC decoder information to specific roster entries, but it accepts any property argument so it can be useful in a variety of scenarios.</p>

<h3 id="arguments">Arguments:</h3>

<ul>
<li><code class="prettyprint">property</code> - This is a roster entry property as a JavaScript object. It is very important that this object is NOT stringified; if you stringify then the function will not work!</li>
</ul>

<h3 id="returns">Returns:</h3>

<ul>
<li>An array of roster entry names that have matching properties. For example, if you looked up a property and both <code class="prettyprint">&quot;CBQ2&quot;</code> and <code class="prettyprint">&quot;Challenger #3985&quot;</code> have matches, the function would return <code class="prettyprint">[&quot;CBQ2&quot;, &quot;Challenger #3985&quot;]</code>.</li>
</ul>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
